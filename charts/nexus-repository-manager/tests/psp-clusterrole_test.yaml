suite: psp-clusterrole
templates:
  - psp-clusterrole.yaml
tests:
  - it: is disabled by default
    asserts:
      - hasDocuments:
          count: 0

  - it: renders with defaults
    set:
      psp:
        create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ClusterRole
      - equal:
          path: apiVersion
          value: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels.[app.kubernetes.io/managed-by]
          value: Helm
      - matchRegex:
          path: metadata.labels.[app.kubernetes.io/version]
          pattern: \d+\.\d+\.\d+
      - matchRegex:
          path: metadata.labels.[helm.sh/chart]
          pattern: nexus-repository-manager-\d+\.\d+\.\d+
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: nexus-repository-manager
      - equal:
          path: metadata.annotations
          value: null
      - equal:
          path: rules
          value:
            - apiGroups:
                - policy
              resources:
                - podsecuritypolicies
              resourceNames:
                - nexus-repository-manager
              verbs:
                - use
